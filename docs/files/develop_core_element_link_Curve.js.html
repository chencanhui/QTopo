<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>develop\core\element\link\Curve.js - QTopo</title>
  
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-smart">
 <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
               <a class="navbar-brand mainlogo" href="https://github.com/hai3460377/QTopo">
             
            <img alt="QTopo" src="..\logo.png" title="QTopo">
            
                QTopo
          </a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                 <ul class="nav navbar-nav">
                    
                    <li><a href="./download/qtopo.zip">下载</a>
                    </li>
                    
                </ul>
               <div class="navbar-form navbar-right filterAPi" autocomplete="off">
                <input type="text" id='txtSearchAPI' class="form-control search-query" placeholder="Search for API" />
                 <ul id="filterList" class="filterItems dropdown-menu" role="menu"></ul>
                </div>
            </div>
        </div>
    </nav>
    <div id="sidebar">
    <h3>Modules/Classes</h3>
        <div id="api-tabview-filter">
            <input id='txtSearch' type="search" class="form-control" placeholder="Type to filter Modules/Classes">
        </div>
        <dl id="sidebar_list">
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/component.html">component</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/rightMenu.html">rightMenu</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/core.html">core</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/[C] Container.html">[C] Container</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/Group.html">Group</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/DirectLine.html">DirectLine</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/[LE] Line.html">[LE] Line</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/CurveLink.html">CurveLink</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/DirectLink.html">DirectLink</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/FlexionalLink.html">FlexionalLink</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/FoldLink.html">FoldLink</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/[L] Link.html">[L] Link</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/ImageNode.html">ImageNode</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/[N] Node.html">[N] Node</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/TextNode.html">TextNode</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/[E] Element.html">[E] Element</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/Scene.html">Scene</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
                <dt>
                    <span class="glyphicon glyphicon-minus"></span>
                    <a href="../modules/QTopo.html">QTopo</a>
                </dt>
                <dd>
                    <ul>
                   
                       <li>
                            
                           <a href="../classes/QTopo.html">QTopo</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/QTopo.instance.html">QTopo.instance</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                       <li>
                            
                           <a href="../classes/QTopo.util.html">QTopo.util</a>
                           <ul>
                                
                           </ul>
                       </li>
                    
                    </ul>
                </dd>
             
        </dl>
</div>
   
    <div class="stdoc-content">
        <!--     <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>

 -->
        <div class="apidocs">
            <div id="docs-main">
                <div class="content">
                    <div class="page-header">
    <h1>develop\core\element\link\Curve.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums" id='src_code'>
/**
 * @module core
 */
/**
 * 曲线链路
 * @class  CurveLink
 * @constructor
 * @extends [L] Link
 * @param [config] 配置参数，无参则按全局配置创建
 */
var Link = require(&quot;./Link.js&quot;);
module.exports = {
    constructor: CurveLink,
    setDefault: setDefault,
    getDefault: getDefault
};
//-
var DEFAULT = {
    number: 1,
    alpha: 1,
    color: &#x27;22,124,255&#x27;,
    arrow: {
        size: 10,
        offset: 0,
        start: false,
        end: false
    },
    jsonId:&quot;&quot;,
    gap: 20,
    width: 2,
    dashed: null,
    zIndex: 100,
    font: {
        size: 16,
        type: &quot;微软雅黑&quot;,
        color: &#x27;255,255,255&#x27;
    },
    useType: QTopo.constant.link.CURVE,
    curveOffset: 200
};
function setDefault(config) {
    QTopo.util.extend(DEFAULT, config || {});
}
function getDefault() {
    return QTopo.util.deepClone(DEFAULT);
}
//------
var jtopoRest={
    //改写源码绘制二次贝赛尔曲线
    //修改始终点的位置，用以确定箭头方向
    getStart: function () {
        var a;
        var b = this.nodeA, c = this.nodeZ;
        var d = JTopo.util.lineF(b.cx, b.cy, c.cx, c.cy);
        var e = b.getBound();
        a = JTopo.util.intersectionLineBound(d, e);
        return a;
    },
    getEnd:function () {
        var a;
        var b = this.nodeZ, c = this.nodeA;
        var d = JTopo.util.lineF(b.cx, b.cy, c.cx, c.cy);
        var e = b.getBound();
        a = JTopo.util.intersectionLineBound(d, e);
        return a;
    },
    //获取曲线的路径点，返回应是数组
    getPath:function () {
        var path = [], start = this.getStartPosition(), end = this.getEndPosition();
        if (this.nodeA === this.nodeZ)return [start, end];
        if (start &amp;&amp; end) {
            var angle = Math.atan(Math.abs(end.y - start.y) / Math.abs(end.x - start.x));
            var mX = (start.x + end.x) / 2 + this.qtopo.attr.curveOffset * Math.cos(angle - Math.PI / 2);
            var mY = (start.y + end.y) / 2 + this.qtopo.attr.curveOffset * Math.sin(angle - Math.PI / 2);
            path.start = start;
            path.end = end;
            path.middle = {
                x: mX,
                y: mY
            };
            path.text =  makePoint(path.start,path.middle, path.end, 1/2);
            path.angle = angle;
            path.push(start);
            path.push(end);
        }
        return path
    },
    //绘制曲线路径
    paintPath:function (cx, path) {
        if (this.nodeA === this.nodeZ)return void this.paintLoop(cx);
        var start = path.start;
        var end = path.end;
        var middle = path.middle;
        if (start &amp;&amp; end &amp;&amp; middle) {
            cx.beginPath();
            cx.moveTo(start.x, start.y);
            cx.strokeStyle = &quot;rgba(&quot; + this.strokeColor + &quot;,&quot; + this.alpha + &quot;)&quot;;
            cx.lineWidth = this.lineWidth;
            cx.moveTo(start.x, start.y);
            cx.quadraticCurveTo(middle.x, middle.y, end.x, end.y);
            cx.stroke();
            if (cx.stroke(), cx.closePath(), null != this.arrowsRadius) {
                if (this.qtopo.attr.arrow.end) {
                    this.paintArrow(cx, start, end);
                }
                if (this.qtopo.attr.arrow.start) {
                    this.paintArrow(cx, end, start);
                }
            }
        }
    },
    //线上文本位置
    paintText:function (cx, path) {
        if (path &amp;&amp; path.text &amp;&amp; this.text &amp;&amp; this.text.length &gt; 0) {
            var textX = path.text.x + this.textOffsetX;
            var textY = path.text.y + this.textOffsetY;
            cx.save();
            cx.beginPath();
            cx.font = this.font;
            var totalWidth = cx.measureText(this.text).width;
            var fontWidth = cx.measureText(&quot;田&quot;).width;
            cx.fillStyle = &quot;rgba(&quot; + this.fontColor + &quot;, &quot; + this.alpha + &quot;)&quot;;
            cx.fillText(this.text, textX - totalWidth / 2, textY - fontWidth / 2);
            cx.stroke();
            cx.closePath();
            cx.restore();
        }
    },
    //判断点是否落在曲线上,原理基于二次贝塞尔曲线公式阶段点取样,判断点是否落在每小部分的线段上
    isInBound:function (x, y) {
        if (this.nodeA === this.nodeZ) {
            var d = this.bundleGap * (this.nodeIndex + 1) / 2, e = a.util.getDistance(this.nodeA, {x: x, y: y}) - d;
            return Math.abs(e) &lt;= 3
        }
        //----
        var flag = false;
        var start = this.path.start;
        var end = this.path.end;
        var middle = this.path.middle;
        var angle = this.path.angle;//起始点之间的夹角
        if(start&amp;&amp;end&amp;&amp;middle&amp;&amp;angle){
            var temp1 = start;//首次为起点
            var temp2;
            for (var i = 1; i &lt;= 10; i++) {
                temp2 = makePoint(start, middle, end, i / 10);//取样为10份
                //判断点是否落在temp1和temp2构成的直线上
                if (pointInLine({x: x, y: y}, temp1, temp2, this.width / 2, angle)) {
                    flag = true;
                    break
                }
                temp1 = temp2;
            }
        }
        return flag
    }
};
//----
//制造一个二次贝塞尔曲线的阶段点
function makePoint(s, m, e, t) {
    return {
        x: (1 - t) * (1 - t) * s.x + 2 * t * (1 - t) * m.x + t * t * e.x,
        y: (1 - t) * (1 - t) * s.y + 2 * t * (1 - t) * m.y + t * t * e.y
    }
}
//考虑到线段的粗细,需要判断点是否在矩形内，若点同时在顺时针4个点成的4条线的右侧,则为在矩形内
function pointInLine(p, s, e, w, an) {
    var rectangle = [//顺时针，从左上开始
        {
            x: s.x - w * Math.sin(an),
            y: s.y - w * Math.cos(an)
        },
        {
            x: e.x - w * Math.sin(an),
            y: e.y - w * Math.cos(an)
        },
        {
            x: e.x + w * Math.sin(an),
            y: e.y + w * Math.cos(an)
        },
        {
            x: s.x + w * Math.sin(an),
            y: s.y + w * Math.cos(an)
        }
    ];
    return poinRightLine(rectangle[0], rectangle[1], p) &amp;&amp; poinRightLine(rectangle[1], rectangle[2], p) &amp;&amp; poinRightLine(rectangle[2], rectangle[3], p) &amp;&amp; poinRightLine(rectangle[3], rectangle[0], p);
}
//判断点在线的右侧?
function poinRightLine(s, e, p) {
    return ((e.x - s.x) * (-p.y + s.y) - (-e.y + s.y) * (p.x - s.x)) &lt; 0;
}
//---
//------
//-
function CurveLink(config) {
    if (!config.start || !config.end || !config.start.jtopo || !config.end.jtopo) {
        QTopo.util.error(&quot;Create Link need start and end&quot;);
        return;
    }
    this.attr = QTopo.util.extend(getDefault(), config || {});
    Link.call(this, new JTopo.CurveLink(config.start.jtopo, config.end.jtopo));
    //函数
    this.set = setJTopo;
    //初始化
    this.set(this.attr);
    //改写源码绘制曲线,可由curveOffset指定弧度
    reset(this);
}
QTopo.util.inherits(CurveLink, Link);
//-
/**
 *  元素对属性的统一设置函数，推荐使用
 *
 *  参数可设置一项或多项,未设置部分参考全局配置
 *  @method set
 *  @param config
 *  @example
 *          实际参数参考attr内属性,只会修改有对应set函数的属性,若新增属性且添加了setXXX函数，也可用此函数配置
 *          如:name 对应 setName(&quot;..&quot;)
 *          参数格式如下
 *          config={
 *              xx:...,
 *              xx:...
 *          }
 */
function setJTopo(config) {
    if (config) {
        var self = this;
        self._setAttr(config);
    }
}
function reset(link) {
    link.jtopo.getStartPosition =jtopoRest.getStart;
    link.jtopo.getEndPosition =jtopoRest.getEnd;
    link.jtopo.paintPath =jtopoRest.paintPath;
    link.jtopo.getPath =jtopoRest.getPath;
    link.jtopo.isInBound = jtopoRest.isInBound;
    link.jtopo.paintText =jtopoRest.paintText;
}
//-
/**
 *  设置曲线偏移量
 *
 *  @method setCurveOffset
 *  @param curveOffset {number}
 */
CurveLink.prototype.setCurveOffset = function (curveOffset) {
    if ($.isNumeric(curveOffset)) {
        this.attr.curveOffset = parseInt(curveOffset);
    }
};
/**
 * 获取元素全局样式
 * @method getDefault
 * @return {object}
 * @example
 *          var DEFAULT = {
                                number: 1,
                                alpha: 1,
                                color: &#x27;22,124,255&#x27;,
                                arrow: {
                                    size: 10,
                                    offset: 0,
                                    start: false,
                                    end: false
                                },
                                jsonId:&quot;&quot;,
                                gap: 20,
                                width: 2,
                                dashed: null,
                                zIndex: 100,
                                font: {
                                    size: 16,
                                    type: &quot;微软雅黑&quot;,
                                    color: &#x27;255,255,255&#x27;
                                },
                                useType: QTopo.constant.link.CURVE,
                                curveOffset: 200
                            };
 */
CurveLink.prototype.getDefault = getDefault;
//-
    </pre>
</div>

                </div>
            </div>
        </div>
    </div>
<a id="gotoTop" class='well well-small' href='#'>
    Top
</a>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/config.js"></script>
<script src="../assets/js/doc.js"></script>
</body>
</html>
