<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="css/Qtopo.min.css" rel="stylesheet">
    <script>
        //重写日志函数，加入时间标记
        Date.prototype.Format = function (fmt) { //author: meizz
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        };
        var fn = window.console.info;
        window.console.info = function () {
            var data = [new Date().Format("hh:mm:ss")];
            for (var i = 0; i < arguments.length; i++) {
                data.push(arguments[i]);
            }
            fn.apply(this, data);
        };
    </script>
    <script src="js/jquery.min.js"></script>
    <!--<script src="js/jquery-nicescroll/jquery.nicescroll.min.js"></script>-->
    <script src="js/Qtopo.bundle.js"></script>
    <style>
    </style>
</head>
<body>
<canvas class="topo_base" width="1000px" height="1000px"></canvas>
<script>
    $(document).ready(function () {
        var topo = QTopo.init(document.getElementsByClassName("topo_base")[0], {
            background: "img/bg1.jpg"
        });
        var dataUrl="./data/data.json";
        var alarmUrl="./data/alarm.json";
        $.ajax(dataUrl).done(function(data){
            $.ajax(alarmUrl).done(function(alarm){
                drawTopo(data, alarm);
            });
        });
        function drawTopo(data, alarm) {
            alarm = QTopo.util.toJson(alarm);
            data = QTopo.util.toJson(data);
            var node = data.WebTopo.NetView.Nodes.Node;
            var group = data.WebTopo.NetView.Groups.Group;
            var link = data.WebTopo.NetView.Links.Link;

            var fixX = parseInt(data.WebTopo.NetView.XY["@iMinX"]);
            var fixY = parseInt(data.WebTopo.NetView.XY["@iMinY"]);

            //构造节点数据
            var nodeData = [];
            $.each(node, function (i, v) {
                var newNode = {
                    size:[64,64],
                    name: v["@name"],
                    image: "img/node.png",
                    position: [parseInt(v["@x"]) + fixX, parseInt(v["@y"]) + fixY],
                    id: v["@id"],
                    pid: v["@pid"]

                };
                if (v.p) {
                    $.each(v.p, function (i, v) {
                        if (v["@k"] == "mo_id") {
                            newNode.alarmId = v["$"];
                        }
                    });
                }
                nodeData.push(newNode);
            });
            //添加object数据到节点里
            var object = data.WebTopo.NetView.Objects.Object;
            nodeData.push({
                name: object["@name"],
                image: "img/node.png",
                position: [parseInt(object["@x"]) + fixX, parseInt(object["@y"]) + fixY],
                id: object["@id"],
                pid: object["@pid"]
            });
            //构造分组数据
            var containerData = [];
            $.each(group, function (i, v) {
                var data = [];
                if ($.isArray(v["Node"])) {
                    $.each(v["Node"], function (j, k) {
                        data.push(k["@id"]);
                    });
                } else {
                    data.push(v["Node"]["@id"]);
                }
                containerData.push({
                    id: v["@id"],
                    pid: v["@pid"],
                    name: v["@name"],
                    data: data
                });
            });
            //构造链接数据
            var linkData = [];
            $.each(link, function (i, v) {
                linkData.push({
                    pid: v["@pid"],
                    start: v["@from"],
                    end: v["@to"]
                });
            });
            //构造告警
            var alarmData = [];
            var alarmColor = ["255,0,0", "255, 102, 0", "255,204,0", "0,0,255"];
            $.each(alarm, function (i, v) {
                alarmData.push({
                    alarmId: v["alarmneid"],
                    color: alarmColor[v["alarmcolor"]]
                });
            });
            topo.setOption({
                node: {
                    exprop: ["id", "pid", "alarmId"],
                    data: nodeData
                },
                container: {
                    children: "id",
                    exprop: ["id", "pid"],
                    data: containerData
                },
                link: {
                    path: ["id"],
                    exprop: ["pid"],
                    data: linkData
                },
                alarm: {
                    node: "alarmId",
                    data: alarmData,
                    animate:{
                        time:1000,
                        callBack:function(node){
                            console.info(node);
                        }
                    }
                }
            });
        }
    });
</script>
</body>
</html>